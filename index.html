<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mos√°s nyilv√°ntart√°s</title>
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#0b1220; --border:#334155; --text:#e5e7eb; --accent:#22d3ee; --danger:#ef4444; }
    :root.light{ --bg:#f9fafb; --panel:#ffffff; --muted:#f3f4f6; --border:#d1d5db; --text:#111827; --accent:#0ea5e9; --danger:#dc2626; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);transition:background .3s,color .3s}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    h1{margin:0;font-size:1.5rem}
    .theme-toggle{cursor:pointer;font-size:1.3rem;background:none;border:none;color:var(--text)}
    .card{padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--panel);margin-bottom:16px;transition:background .3s,border .3s}
    fieldset{border:none;margin:0;padding:0;display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{font-size:14px}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--muted);color:var(--text);transition:background .3s,color .3s,border .3s}
    .row-2{grid-column:span 2}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    button{border:none;padding:10px 14px;border-radius:10px;cursor:pointer;color:#0b1220;font-weight:600;transition:background .3s}
    .primary{background:var(--accent)}
    .muted{background:#1f2937;color:var(--text)}
    :root.light .muted{background:#e5e7eb;color:#111827}
    .danger{background:var(--danger);color:white}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px 10px;text-align:left}
    th{background:var(--muted);user-select:none}
    thead th{position:sticky; top:0; z-index:1}
    th.sortable{cursor:pointer}
    th.sortable::after{content:'';float:right;margin-left:6px;opacity:0.6}
    th.sortable.asc::after{content:'‚ñ≤'}
    th.sortable.desc::after{content:'‚ñº'}
    #dataTable tbody tr:hover {background: rgba(34,211,238,0.15); cursor:pointer;}
    #dataTable tbody tr.selected {background: rgba(34,211,238,0.35);}    
    .radio-group{display:flex;gap:10px;align-items:center}
    .segmented{display:inline-flex;gap:8px;background:var(--muted);border:1px solid var(--border);border-radius:12px;padding:6px}
    .segmented input[type=radio]{position:absolute;opacity:0;pointer-events:none}
    .segmented label{padding:8px 12px;border-radius:8px;cursor:pointer;user-select:none;border:1px solid transparent;min-width:64px;text-align:center}
    .segmented input[type=radio]:focus + label{outline:2px solid color-mix(in oklab, var(--accent) 60%, transparent)}
    .segmented input[type=radio]:checked + label{background:var(--accent); color:#0b1220; font-weight:700}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);z-index:50}
    .modal-card{width:min(420px,90vw);background:var(--muted);border:1px solid var(--border);border-radius:14px;padding:16px}
    .modal-card h3{margin:0 0 8px 0}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .hint{font-size:12px;opacity:.8}
    .error{color:#fecaca;font-size:13px;min-height:18px}
    .machine-info{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .machine-info img{width:140px;max-height:110px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#fff}
    .link-btn{display:inline-block;text-decoration:none;padding:8px 12px;border-radius:10px}
    .filters{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .filters .col-2{grid-column:span 2}
    .filters .col-3{grid-column:span 3}
    .filters .col-6{grid-column:span 6}
    @media(max-width:900px){.filters{grid-template-columns:repeat(2,1fr)} .filters .col-3,.filters .col-6{grid-column:span 2}}
    .toast-wrap{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:100}
    .toast{background:var(--panel); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.3);}    
    /* Progress bar */
    .progress-wrap{display:flex;align-items:center;gap:10px}
    .progress{flex:1;height:12px;background:var(--muted);border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress > span{display:block;height:100%;width:0%}
    .progress > span.ok{background:linear-gradient(90deg, var(--accent), #34d399)}
    .progress > span.warn{background:linear-gradient(90deg, #fbbf24, #f59e0b)}
    .progress > span.danger{background:linear-gradient(90deg, #ef4444, #dc2626)}
    .timer-meta{min-width:180px;text-align:right;font-variant-numeric:tabular-nums}
    .small{font-size:12px;opacity:.85}
  </style>
</head>
<body>
  <div class="container">
    <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

    <header>
      <h1>üß∫ Mos√°s nyilv√°ntart√°s</h1>
      <div style="display:flex;align-items:center;gap:10px">
        <div id="autosaveStatus">Automatikus ment√©s akt√≠v</div>
        <button id="themeToggle" class="theme-toggle" title="Vil√°gos/S√∂t√©t m√≥d">üåô</button>
      </div>
    </header>

    <!-- G√©p inform√°ci√≥ blokk -->
    <section class="card" aria-labelledby="machineInfoTitle">
      <h2 id="machineInfoTitle" style="margin:0 0 8px 0;font-size:1.1rem">Mos√≥g√©p: <strong>CANDY RPW 4856BWR8</strong></h2>
      <div class="machine-info">
        <img id="machinePhoto" src="Candy.webp" alt="CANDY RPW 4856BWR8" />
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <a class="link-btn primary" href="https://d15v10x8t3bz3x.cloudfront.net/Libretti/2024/8/17229341/70029341WDRapidoRPWNECCSHUROSK" target="_blank" rel="noopener">üìò K√©zik√∂nyv (HU/RO/SK)</a>
          <a class="link-btn muted" href="https://docgenerator.candy.it/docgenerator/productdetails?lan=HU&sku=31019842&mkt=hu" target="_blank" rel="noopener">üìÑ Term√©klap</a>
          <small style="opacity:.85">A programlista a k√©zik√∂nyv Programt√°bl√°zat alapj√°n lett el≈ët√∂ltve.</small>
        </div>
      </div>
    </section>

    <!-- VISSZASZ√ÅML√ÅL√ì / PROGRESS -->
    <section class="card" aria-labelledby="timerTitle">
      <h2 id="timerTitle" style="margin:0 0 8px 0;font-size:1.1rem">Visszasz√°ml√°l√≥</h2>
      <div class="progress-wrap">
        <div class="progress" aria-label="Folyamat el≈ërehalad√°s"><span id="progBar" class="ok"></span></div>
        <div class="timer-meta">
          <div id="timerLabel">Nincs akt√≠v program</div>
          <div class="small" id="timerSub"></div>
        </div>
      </div>
      <div class="actions" style="margin-top:10px;align-items:center">
        <div style="display:flex;gap:8px;align-items:center">
          <input type="number" id="customMin" min="1" max="240" step="1" placeholder="perc" style="width:110px" title="K√©zi perc megad√°sa (opcion√°lis)">
          <button type="button" class="primary" id="startTimerBtn" disabled>‚ñ∂Ô∏è Ind√≠t√°s (kijel√∂lt sor)</button>
          <button type="button" class="muted" id="stopTimerBtn" disabled>‚èπ Le√°ll√≠t√°s</button>
        </div>
        <label class="small" id="timerHint">Adj meg k√©zzel perceket vagy haszn√°ld az automatikus programid≈ët.</label>
      </div>
    </section>

    <!-- SZ≈∞R≈êK -->
    <section class="card" aria-labelledby="filtersTitle">
      <h2 id="filtersTitle" style="margin:0 0 8px 0;font-size:1.1rem">Sz≈±r≈ëk</h2>
      <div class="filters">
        <div class="col-3">
          <label for="searchQ">Gyors keres√©s</label>
          <input id="searchQ" placeholder="N√©v, t√©tel, program, mos√≥szer, √∂bl√≠t≈ë..." />
        </div>
        <div>
          <label for="fromDate">D√°tumt√≥l</label>
          <input type="date" id="fromDate" />
        </div>
        <div>
          <label for="toDate">D√°tumig</label>
          <input type="date" id="toDate" />
        </div>
        <div>
          <label for="personFilter">Szem√©ly</label>
          <select id="personFilter"><option value="">(Mind)</option></select>
        </div>
        <div>
          <label for="programFilter">Program</label>
          <select id="programFilter"><option value="">(Mind)</option></select>
        </div>
        <div>
          <label for="dryFilter">Sz√°r√≠t√°s</label>
          <select id="dryFilter">
            <option value="">(Mind)</option>
            <option>Igen</option>
            <option>Nem</option>
          </select>
        </div>
        <div class="col-6" id="stats" style="margin-bottom:6px;opacity:.9"></div>
        <div class="col-6">
          <button id="resetFilters" class="muted" type="button">Sz≈±r≈ëk t√∂rl√©se</button>
        </div>
      </div>
    </section>

    <!-- ≈∞RLAP -->
    <section class="card">
      <form id="washForm" autocomplete="off">
        <input type="hidden" id="entryId" />
        <fieldset>
          <div>
            <label for="date">D√°tum</label>
            <input type="date" id="date" required />
          </div>
          <div>
            <label for="person">Szem√©ly</label>
            <input id="person" placeholder="pl. Anna" list="personsDatalist" required />
            <datalist id="personsDatalist"></datalist>
          </div>
          <div class="row-2">
            <label for="program">Program</label>
            <select id="program"></select>
            <div style="display:flex;gap:8px;margin-top:6px">
              <input id="programNew" placeholder="√öj program hozz√°ad√°sa (pl. Pamut 40)" />
              <button type="button" class="muted" id="programAdd">+ Hozz√°ad√°s</button>
            </div>
          </div>
          <div>
            <label for="temp">H≈ëfok (¬∞C)</label>
            <input id="temp" type="number" min="0" max="95" step="5" placeholder="40" />
          </div>
          <div>
            <label for="spin">Centrifuga (rpm)</label>
            <input id="spin" type="number" min="0" max="1400" step="100" placeholder="1000" />
          </div>
          <div>
            <label for="color">Sz√≠n</label>
            <select id="color">
              <option>Vegyes</option>
              <option>Feh√©r</option>
              <option>Sz√≠nes</option>
              <option>Fekete</option>
            </select>
          </div>
          <div>
            <label for="qty">Darabsz√°m</label>
            <input id="qty" type="number" min="1" value="1" required />
          </div>
          <div class="row-2">
            <label for="item">T√©tel(ek)</label>
            <input id="item" placeholder="pl. p√≥l√≥k, t√∂r√∂lk√∂z≈ëk" required />
          </div>
          <div class="row-2">
            <label>Sz√°r√≠t√°s</label>
            <div class="radio-group">
              <div class="segmented">
                <input type="radio" id="dryYes" name="dry" value="Igen" checked>
                <label for="dryYes">Igen</label>
                <input type="radio" id="dryNo" name="dry" value="Nem">
                <label for="dryNo">Nem</label>
              </div>
            </div>
          </div>
          <div class="row-2">
            <label for="detergent">Mos√≥szer</label>
            <select id="detergent"></select>
            <div class="inline-add" style="display:flex;gap:8px;margin-top:6px">
              <input id="detergentNew" placeholder="√öj mos√≥szer hozz√°ad√°sa" />
              <button type="button" class="muted" id="detergentAdd">+ Hozz√°ad√°s</button>
            </div>
          </div>
          <div class="row-2">
            <label for="softener">√ñbl√≠t≈ë</label>
            <select id="softener"></select>
            <div class="inline-add" style="display:flex;gap:8px;margin-top:6px">
              <input id="softenerNew" placeholder="√öj √∂bl√≠t≈ë hozz√°ad√°sa" />
              <button type="button" class="muted" id="softenerAdd">+ Hozz√°ad√°s</button>
            </div>
          </div>
        </fieldset>
        <div class="actions">
          <button type="submit" class="primary" id="saveBtn">Hozz√°ad√°s</button>
          <button type="button" class="muted" id="resetBtn">≈∞rlap t√∂rl√©se</button>
          <button type="button" class="danger" id="deleteBtn" disabled>T√∂rl√©s</button>
          <button type="button" class="muted" id="exportAll">√ñsszes export (JSON)</button>
          <label class="muted" style="display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;cursor:pointer">
            Import (JSON)
            <input id="importAll" type="file" accept="application/json" style="display:none" />
          </label>
        </div>
      </form>
    </section>

    <!-- T√ÅBL√ÅZAT -->
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <strong>Bejegyz√©sek</strong>
        <small id="countInfo" style="opacity:.8"></small>
      </div>
      <table id="dataTable">
        <thead>
          <tr>
            <th class="sortable" data-sort="date">D√°tum</th>
            <th class="sortable" data-sort="person">Szem√©ly</th>
            <th>T√©tel</th>
            <th class="sortable" data-sort="qty">Darab</th>
            <th>Mos√≥g√©p</th>
            <th class="sortable" data-sort="program">Program</th>
            <th>R√©szletek</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="emptyState" style="opacity:.8;margin-top:8px;display:none">Nincs tal√°lat a be√°ll√≠tott sz≈±r≈ëkre.</div>
    </section>
  </div>

  <div id="pinModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
    <div class="modal-card">
      <h3 id="pinTitle">PIN sz√ºks√©ges</h3>
      <p class="hint">Add meg a 4 sz√°mjegy≈± PIN k√≥dot a t√∂rl√©shez.</p>
      <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="letter-spacing:4px;text-align:center" />
      <div class="error" id="pinError"></div>
      <div class="modal-actions">
        <button type="button" class="muted" id="pinCancel">M√©gse</button>
        <button type="button" class="primary" id="pinOk">OK</button>
      </div>
    </div>
  </div>

  <template id="rowTemplate">
    <tr>
      <td data-col="date"></td>
      <td data-col="person"></td>
      <td data-col="item"></td>
      <td data-col="qty"></td>
      <td data-col="machine"></td>
      <td data-col="program"></td>
      <td data-col="details"></td>
    </tr>
  </template>

  <script>
    // ----- √Ålland√≥k √©s √°llapot -----
    const DATA_KEY = 'laundry_simple_v9';
    const DET_KEY  = 'laundry_detergents_v1';
    const SOFT_KEY = 'laundry_softeners_v1';
    const PROG_KEY = 'laundry_programs_v1';
    const THEME_KEY= 'laundry_theme';
    const SORT_KEY = 'laundry_sort_v1';
    const PIN_KEY  = 'laundry_pin_v1';
    const RUN_KEY  = 'laundry_running_v1';
    const DEFAULT_PIN = '2024';

    let entries = [];
    let detergents = [];
    let softeners = [];
    let programs = [];
    let editId = null;
    let sortState = { col:null, dir:1 };

    const $ = s => document.querySelector(s);

    function uid(){return 'e'+Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4)}
    function today(){return new Date().toISOString().slice(0,10)}
    function currentPIN(){ return localStorage.getItem(PIN_KEY) || DEFAULT_PIN; }
    function safeParse(json, fallback){ try{ const v = JSON.parse(json); return v==null?fallback:v; } catch{ return fallback; } }

    // ----- T√©ma -----
    function applyTheme(theme){
      if(theme==='light') document.documentElement.classList.add('light');
      else document.documentElement.classList.remove('light');
      localStorage.setItem(THEME_KEY, theme);
      $('#themeToggle').textContent = theme==='light' ? 'üåû' : 'üåô';
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved){ applyTheme(saved); }
      else {
        const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        applyTheme(prefersLight ? 'light' : 'dark');
        const mq = window.matchMedia('(prefers-color-scheme: light)');
        mq.addEventListener && mq.addEventListener('change', e=>{
          if(!localStorage.getItem(THEME_KEY)) applyTheme(e.matches ? 'light' : 'dark');
        });
      }
    }

    // ----- Ment√©s / Bet√∂lt√©s -----
    function saveAll(){
      localStorage.setItem(DATA_KEY, JSON.stringify(entries));
      localStorage.setItem(DET_KEY, JSON.stringify(detergents));
      localStorage.setItem(SOFT_KEY, JSON.stringify(softeners));
      localStorage.setItem(PROG_KEY, JSON.stringify(programs));
      localStorage.setItem(SORT_KEY, JSON.stringify(sortState));
      $('#autosaveStatus').textContent='Mentve '+new Date().toLocaleTimeString('hu-HU');
    }
    function loadAll(){
      entries    = safeParse(localStorage.getItem(DATA_KEY), []);
      detergents = safeParse(localStorage.getItem(DET_KEY), ['Ariel','Persil','OMO','Tommy']);
      softeners  = safeParse(localStorage.getItem(SOFT_KEY), ['Lenor','Silan','Softlan','Nincs']);
      programs   = safeParse(localStorage.getItem(PROG_KEY), [
        'ECO 40-60', 'GYAPJ√ö/K√âZI', "GYORS 14'", "GYORS 30'", "GYORS 44'",
        'K√ñNNY≈∞ VASAL√ÅS PLUSZ', 'M≈∞SZ√ÅL √âS SZ√çNES', '√ñBL√çT√âS', 'PAMUT', "SPECIAL 39'", "T√ñK√âLETES PAMUT 59'", "VEGYES √âS SZ√çNES 59'"
      ].sort((a,b)=>a.localeCompare(b,'hu')));
      sortState  = safeParse(localStorage.getItem(SORT_KEY), {col:null,dir:1});
      rebuildSelects();
      rebuildFilterOptions();
      updateStats();
      render();
    }

    // ----- Selectek -----
    function rebuildSelects(){
      const detSel = $('#detergent');
      const sofSel = $('#softener');
      const progSel = $('#program');
      detSel.innerHTML = ''; sofSel.innerHTML=''; progSel.innerHTML='';
      for(const v of detergents){ const o=document.createElement('option'); o.textContent=v; o.value=v; detSel.appendChild(o); }
      for(const v of softeners){ const o=document.createElement('option'); o.textContent=v; o.value=v; sofSel.appendChild(o); }
      for(const v of programs){ const o=document.createElement('option'); o.textContent=v; o.value=v; progSel.appendChild(o); }
      if(detergents[0]) detSel.value = detSel.value || detergents[0];
      if(softeners[0])  sofSel.value = sofSel.value || softeners[0];
      if(programs[0])   progSel.value = progSel.value || programs[0];
    }

    // ----- Sz≈±r≈ëk -----
    function rebuildFilterOptions(){
      const persons = Array.from(new Set(entries.map(e=>e.person).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'hu'));
      const personSel = $('#personFilter');
      personSel.innerHTML = '<option value="">(Mind)</option>' + persons.map(p=>`<option>${p}</option>`).join('');
      const dl = document.getElementById('personsDatalist');
      if(dl){ dl.innerHTML = persons.map(p=>`<option value="${p}">`).join(''); }

      const progSel = $('#programFilter');
      progSel.innerHTML = '<option value="">(Mind)</option>' + programs.map(p=>`<option>${p}</option>`).join('');
    }

    function getFilters(){
      return {
        q: ($('#searchQ').value||'').toLowerCase(),
        from: $('#fromDate').value || '',
        to: $('#toDate').value || '',
        person: $('#personFilter').value || '',
        program: $('#programFilter').value || '',
        dry: $('#dryFilter').value || ''
      };
    }

    function passFilters(e, f){
      if(f.from && e.date < f.from) return false;
      if(f.to   && e.date > f.to)   return false;
      if(f.person && e.person !== f.person) return false;
      if(f.program && e.program !== f.program) return false;
      if(f.dry && e.dry !== f.dry) return false;
      if(f.q){
        const hay = [e.person,e.item,e.program,e.detergent,e.softener,e.color,String(e.qty)].join(' ').toLowerCase();
        if(!hay.includes(f.q)) return false;
      }
      return true;
    }

    function attachFilterEvents(){
      ['searchQ','fromDate','toDate','personFilter','programFilter','dryFilter'].forEach(id=>{
        const el = document.getElementById(id);
        el && el.addEventListener('input', render);
        el && el.addEventListener('change', render);
      });
      document.getElementById('resetFilters').addEventListener('click', ()=>{
        ['searchQ','fromDate','toDate'].forEach(id=>document.getElementById(id).value='');
        ['personFilter','programFilter','dryFilter'].forEach(id=>document.getElementById(id).value='');
        render();
      });
    }

    // ----- Rendez√©s -----
    function compareValues(a,b,type){
      if(type==='date'){ return a.localeCompare(b); }
      if(type==='qty'){ return (Number(a)||0) - (Number(b)||0); }
      return a.localeCompare(b,'hu');
    }

    // ----- Program ikonok -----
    function iconFor(p){
      const s = (p||'').toLowerCase();
      if(s.includes('pamut')) return 'üëï';
      if(s.includes('gyors')) return '‚è±Ô∏è';
      if(s.includes('eco')) return 'üçÉ';
      if(s.includes('gyapj√∫')||s.includes('k√©zi')) return 'üêë';
      if(s.includes('m≈±sz√°l')||s.includes('sz√≠nes')) return 'üßµ';
      if(s.includes('√∂bl√≠t√©s')) return 'üíß';
      if(s.includes('vegye')||s.includes('vegyes')) return 'üéõÔ∏è';
      if(s.includes('special')) return '‚≠ê';
      return 'üß∫';
    }

    // ----- Visszasz√°ml√°l√≥ / Progress -----
    const PROGRAM_MIN = {
      "ECO 40-60": 180,
      "PAMUT": 150,
      "T√ñK√âLETES PAMUT": 59,
      "GYORS 14'": 14,
      "GYORS 30'": 30,
      "GYORS 44'": 44,
      "GYAPJ√ö": 60,
      "GYAPJ√ö/K√âZI": 60,
      "M≈∞SZ√ÅL √âS SZ√çNES": 75,
      "√ñBL√çT√âS": 20,
      "SPECIAL 39'": 39,
      "VEGYES √âS SZ√çNES 59'": 59
    };
    let timer = null;
    let running = null; // {id, start, end, program, minutes}

    function guessMinutes(program){
      const custom = Number(document.getElementById('customMin')?.value||0);
      if(custom && custom>0) return Math.min(240, Math.max(1, Math.floor(custom)));
      const name = (program||'').toUpperCase();
      for(const k of Object.keys(PROGRAM_MIN)){
        if(name.includes(k)) return PROGRAM_MIN[k];
      }
      const m = name.match(/(\d{1,3})\s*['‚Äô]?/);
      if(m) return Math.max(5, Number(m[1]));
      return 60; // alap√©rtelmezett
    }

    function loadRunning(){ running = safeParse(localStorage.getItem(RUN_KEY), null); if(running){ tickTimer(true); enableTimerButtons(true); } }
    function saveRunning(){ localStorage.setItem(RUN_KEY, JSON.stringify(running)); }
    function clearRunning(){ running=null; localStorage.removeItem(RUN_KEY); updateTimerUI(); enableTimerButtons(false); }

    function enableTimerButtons(active){
      const stopBtn = document.getElementById('stopTimerBtn'); if(stopBtn) stopBtn.disabled = !active;
    }

    function startTimerFor(id){
      const e = entries.find(x=>x.id===id);
      if(!e){ showToast('Nincs kijel√∂lt bejegyz√©s'); return; }
      const minutes = guessMinutes(e.program);
      const start = Date.now();
      const end = start + minutes*60*1000;
      running = { id:e.id, program:e.program, minutes, start, end };
      saveRunning();
      updateTimerUI();
      tickTimer(true);
      enableTimerButtons(true);
      requestNotify();
      showToast('Visszasz√°ml√°l√≥ elind√≠tva ('+minutes+' perc)');
    }

    function stopTimer(){ if(timer) clearInterval(timer); timer=null; clearRunning(); showToast('Visszasz√°ml√°l√≥ le√°ll√≠tva'); }

    function formatMS(ms){ const t=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(t/60); const s=t%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

    function updateTimerUI(){
      const bar = document.getElementById('progBar');
      const label = document.getElementById('timerLabel');
      const sub = document.getElementById('timerSub');
      if(!bar||!label||!sub) return;
      if(!running){ bar.style.width='0%'; bar.className=''; label.textContent='Nincs akt√≠v program'; sub.textContent=''; return; }
      label.textContent = `${iconFor(running.program)} ${running.program}`;
      const total = running.minutes*60*1000; const done = Math.min(total, Math.max(0, Date.now()-running.start));
      const pct = Math.round((done/total)*100);
      bar.style.width = pct+'%';
      bar.className = pct<70? 'ok' : (pct<90? 'warn' : 'danger');
      const remain = running.end - Date.now();
      const endTime = new Date(running.end).toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'});
      sub.textContent = `H√°tral√©v≈ë: ${formatMS(remain)} ‚Ä¢ V√©ge: ${endTime}`;
    }

    function tickTimer(immediate){
      if(timer) clearInterval(timer);
      updateTimerUI();
      timer = setInterval(()=>{
        updateTimerUI();
        if(running && Date.now()>=running.end){ onTimerDone(); }
      }, 1000);
      if(immediate) updateTimerUI();
    }

    function onTimerDone(){
      if(timer) { clearInterval(timer); timer=null; }
      notify('Mos√°s k√©sz', `${running.program} befejez≈ëd√∂tt.`);
      chime();
      showToast('‚è∞ Program lej√°rt');
      clearRunning();
    }

    // ----- Toast -----
    function showToast(msg){
      const wrap = document.getElementById('toastWrap');
      const el = document.createElement('div');
      el.className='toast';
      el.textContent=msg;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .4s'; }, 2000);
      setTimeout(()=>{ el.remove(); }, 2600);
    }

    // ----- √ârtes√≠t√©s + hang -----
    function requestNotify(){ if('Notification' in window && Notification.permission==='default'){ Notification.requestPermission(); } }
    function notify(title,body){ try{ if('Notification' in window && Notification.permission==='granted'){ new Notification(title,{body}); } }catch(_){} }
    function chime(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.value=0.001; o.start(); const now=ctx.currentTime; g.gain.exponentialRampToValueAtTime(0.2, now+0.05); g.gain.exponentialRampToValueAtTime(0.0001, now+0.8); o.stop(now+0.9);}catch(_){} }

    // ----- CRUD -----
    function addToList(kind, value){
      value = (value||'').trim();
      if(!value) return;
      if(kind==='det'){ if(!detergents.includes(value)) detergents.push(value); $('#detergent').value=value; $('#detergentNew').value=''; }
      if(kind==='sof'){ if(!softeners.includes(value)) softeners.push(value); $('#softener').value=value; $('#softenerNew').value=''; }
      if(kind==='prog'){ if(!programs.includes(value)) programs.push(value); programs.sort((a,b)=>a.localeCompare(b,'hu')); $('#program').value=value; $('#programNew').value=''; rebuildFilterOptions(); }
      saveAll(); rebuildSelects();
    }

    function readForm(){
      return {
        id:editId||uid(),
        date:$('#date').value||today(),
        person:$('#person').value.trim(),
        machine:'CANDY RPW 4856BWR8',
        program:$('#program').value,
        temp:$('#temp').value,
        spin:$('#spin').value,
        color:$('#color').value,
        qty:Math.max(1, Number($('#qty').value||1)),
        item:$('#item').value.trim(),
        dry:document.querySelector('input[name="dry"]:checked').value,
        detergent:$('#detergent').value,
        softener:$('#softener').value
      }
    }

    function writeForm(e){
      $('#date').value=e.date; $('#person').value=e.person; $('#program').value=e.program; $('#temp').value=e.temp; $('#spin').value=e.spin; $('#color').value=e.color; $('#qty').value=e.qty; $('#item').value=e.item;
      if(e.dry==='Igen'){ document.getElementById('dryYes').checked=true; } else { document.getElementById('dryNo').checked=true; }
      if(e.detergent){ if(detergents.includes(e.detergent)) $('#detergent').value=e.detergent; else addToList('det', e.detergent); }
      if(e.softener){ if(softeners.includes(e.softener)) $('#softener').value=e.softener; else addToList('sof', e.softener); }
      if(e.program){ if(programs.includes(e.program)) $('#program').value=e.program; else addToList('prog', e.program); }
    }

    function clearForm(){ editId=null; $('#washForm').reset(); $('#date').value=today(); $('#qty').value=1; $('#saveBtn').textContent='Hozz√°ad√°s'; $('#deleteBtn').disabled=true; rebuildSelects(); const st=document.getElementById('startTimerBtn'); if(st) st.disabled=true; }
    function upsert(e){ const i=entries.findIndex(x=>x.id===e.id); if(i>-1) entries[i]=e; else entries.unshift(e); saveAll(); rebuildFilterOptions(); render(); }
    function remove(id){ entries = entries.filter(e=>e.id!==id); saveAll(); rebuildFilterOptions(); render(); }

    // ----- Render + stat -----
    function render(){
      const tb=$('#tableBody'); tb.innerHTML='';
      const f = getFilters();
      let filtered = entries.filter(e=>passFilters(e,f));

      if(sortState.col){
        const type = sortState.col==='date' ? 'date' : (sortState.col==='qty' ? 'qty' : 'text');
        filtered = filtered.slice().sort((x,y)=>{
          const res = compareValues(String(x[sortState.col]||''), String(y[sortState.col]||''), type);
          return res * (sortState.dir||1);
        });
      }

      for(const e of filtered){
        const row = $('#rowTemplate').content.firstElementChild.cloneNode(true);
        row.dataset.id=e.id;
        row.querySelector('[data-col=date]').textContent=e.date;
        row.querySelector('[data-col=person]').textContent=e.person;
        row.querySelector('[data-col=item]').textContent=e.item;
        row.querySelector('[data-col=qty]').textContent=e.qty;
        row.querySelector('[data-col=machine]').textContent=e.machine;
        row.querySelector('[data-col=program]').textContent=iconFor(e.program)+" "+e.program;
        row.querySelector('[data-col=details]').textContent=`${e.temp||'-'}¬∞C / ${e.spin||'-'}rpm / ${e.color||'-'} / Sz√°r√≠t√°s: ${e.dry} / Mos√≥szer: ${e.detergent||'-'} / √ñbl√≠t≈ë: ${e.softener||'-'}`;
        tb.appendChild(row);
      }
      document.getElementById('emptyState').style.display = filtered.length? 'none':'block';

      document.querySelectorAll('th.sortable').forEach(th=>{
        th.classList.remove('asc','desc');
        if(sortState.col===th.dataset.sort) th.classList.add(sortState.dir===1?'asc':'desc');
      });

      const st = document.getElementById('startTimerBtn'); if(st) st.disabled = !editId;
      updateStats(filtered);
    }

    function updateStats(list){
      const arr = Array.isArray(list)? list : entries;
      const totalLoads = arr.length;
      const totalItems = arr.reduce((s,e)=>s+(Number(e.qty)||0),0);
      const countInfo = document.getElementById('countInfo');
      if(countInfo) countInfo.textContent = totalLoads ? `${totalLoads} mos√°s ‚Ä¢ ${totalItems} darab` : '';
      const stats = document.getElementById('stats');
      if(stats) stats.textContent = totalLoads ? `√ñsszesen: ${totalLoads} mos√°s, ${totalItems} darab (sz≈±r√©s szerint)` : '';
    }

    // ----- PIN modal -----
    function openPinModal(){
      return new Promise(resolve=>{
        const modal = $('#pinModal');
        const input = $('#pinInput');
        const err   = $('#pinError');
        const okBtn = $('#pinOk');
        const cancelBtn = $('#pinCancel');
        err.textContent=''; input.value='';
        modal.style.display = 'grid';
        setTimeout(()=>input.focus(), 50);
        function close(){ modal.style.display = 'none'; okBtn.removeEventListener('click',onOk); cancelBtn.removeEventListener('click',onCancel); input.removeEventListener('keydown',onKey); }
        function onOk(){ const entered = input.value.trim(); if(entered === currentPIN()){ close(); resolve(true);} else { err.textContent='Hib√°s PIN.'; input.select(); } }
        function onCancel(){ close(); resolve(false); }
        function onKey(e){ if(e.key==='Enter') onOk(); if(e.key==='Escape') onCancel(); }
        okBtn.addEventListener('click', onOk); cancelBtn.addEventListener('click', onCancel); input.addEventListener('keydown', onKey);
      });
    }

    // ----- Esem√©nyek -----
    document.addEventListener('DOMContentLoaded',()=>{
      initTheme();
      $('#themeToggle').addEventListener('click',()=>{
        const isLight = document.documentElement.classList.contains('light');
        applyTheme(isLight ? 'dark' : 'light');
      });

      $('#date').value = today();
      loadAll();

      const img = document.getElementById('machinePhoto');
      img.onerror = () => { img.style.display='none'; };

      $('#washForm').addEventListener('submit', ev=>{
        ev.preventDefault();
        const e = readForm();
        if(!e.person || !e.item){ alert('A "Szem√©ly" √©s a "T√©tel(ek)" k√∂telez≈ë.'); return; }
        upsert(e); clearForm(); showToast('Bejegyz√©s mentve');
      });

      document.addEventListener('keydown', async (ev)=>{
        if((ev.ctrlKey || ev.metaKey) && ev.key==='Enter'){ ev.preventDefault(); $('#washForm').dispatchEvent(new Event('submit')); }
        if(ev.key==='Escape'){ clearForm(); }
        if(ev.key==='Delete' && editId){ const ok = await openPinModal(); if(ok){ remove(editId); clearForm(); showToast('Bejegyz√©s t√∂r√∂lve'); } }
      });

      $('#resetBtn').addEventListener('click', ()=>{ clearForm(); showToast('≈∞rlap t√∂r√∂lve'); });

      $('#deleteBtn').addEventListener('click', async ()=>{
        if(!editId) return;
        const ok = await openPinModal();
        if(ok){ remove(editId); clearForm(); showToast('Bejegyz√©s t√∂r√∂lve'); }
      });

      $('#tableBody').addEventListener('click', ev=>{
        const tr = ev.target.closest('tr'); if(!tr) return;
        [...$('#tableBody').children].forEach(r=>r.classList.remove('selected'));
        tr.classList.add('selected');
        editId = tr.dataset.id; const e = entries.find(x=>x.id===editId); if(!e) return;
        writeForm(e); $('#saveBtn').textContent='Friss√≠t√©s'; $('#deleteBtn').disabled=false; window.scrollTo({top:0,behavior:'smooth'});
        const st = document.getElementById('startTimerBtn'); if(st) st.disabled = false;
      });

      $('#detergentAdd').addEventListener('click', ()=> { addToList('det', $('#detergentNew').value); showToast('Mos√≥szer hozz√°adva'); });
      $('#softenerAdd').addEventListener('click', ()=> { addToList('sof', $('#softenerNew').value); showToast('√ñbl√≠t≈ë hozz√°adva'); });
      $('#programAdd').addEventListener('click', ()=> { addToList('prog', $('#programNew').value); showToast('Program hozz√°adva'); });

      $('#exportAll').addEventListener('click', ()=>{ exportAll(); showToast('Export√°lva'); });
      $('#importAll').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) importAll(f); e.target.value=''; });

      attachFilterEvents();

      document.querySelectorAll('th.sortable').forEach(th=>{
        th.addEventListener('click',()=>{
          const col = th.dataset.sort;
          if(sortState.col===col){ sortState.dir*=-1; }
          else { sortState.col=col; sortState.dir=1; }
          localStorage.setItem(SORT_KEY, JSON.stringify(sortState));
          render();
        });
      });

      // Visszasz√°ml√°l√≥ gombok
      loadRunning();
      document.getElementById('startTimerBtn').addEventListener('click', ()=>{ if(editId) startTimerFor(editId); else showToast('Jel√∂lj ki egy sort!'); });
      document.getElementById('stopTimerBtn').addEventListener('click', stopTimer);
      requestNotify();
    });

    // ----- Export / Import -----
    function exportAll(){
      const payload = { entries, detergents, softeners, programs, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `mosas_adatok_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }
    function importAll(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(!data || typeof data !== 'object') throw new Error('√ârv√©nytelen f√°jl');
          if(Array.isArray(data.entries)) entries = data.entries; 
          if(Array.isArray(data.detergents)) detergents = data.detergents;
          if(Array.isArray(data.softeners)) softeners = data.softeners;
          if(Array.isArray(data.programs)) programs = data.programs;
          saveAll(); rebuildSelects(); rebuildFilterOptions(); render();
          showToast('Import k√©sz!');
        }catch(err){ alert('Import hiba: '+err.message); }
      };
      reader.readAsText(file);
    }
  </script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  const firebaseConfig = {
    apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
    authDomain: "mosas-nyilvantartas.firebaseapp.com",
    projectId: "mosas-nyilvantartas",
    storageBucket: "mosas-nyilvantartas.firebasestorage.app",
    messagingSenderId: "38259241645",
    appId: "1:38259241645:web:26070b1d0686def9f00c24"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  // Debug m√≥d URL param alapj√°n (?debug=1)
  window._debugCloud = /[?&]debug=1/.test(location.search);
  enableIndexedDbPersistence(db).catch((e)=>{ if(window._debugCloud) console.warn('IndexedDB persistence failed', e); });

  // --- UI helper ---
  function setCloudStatus(msg){
    const el = document.getElementById('autosaveStatus');
    if(el){ el.textContent = msg; }
    if(window._debugCloud) console.log('[CLOUD]', msg);
  }
  }

  // --- Cloud sync guard ---
  window.firebaseReady = false;
  window._cloudApplying = false; // ha felh≈ëb≈ël √©rkezik friss√≠t√©s, ne push-oljuk vissza

  // --- Felh≈ë m≈±veletek ---
  async function cloudPushLists(){
    if(window._cloudApplying) return;
    const listsRef = doc(db, 'lists', 'laundry');
    await setDoc(listsRef, {
      detergents: Array.isArray(window.detergents)? window.detergents : [],
      softeners:  Array.isArray(window.softeners)?  window.softeners  : [],
      programs:   Array.isArray(window.programs)?   window.programs   : []
    }, { merge: true });
  }
  async function cloudPushAll(){
    if(window._cloudApplying) return;
    await cloudPushLists();
    const base = collection(db, 'entries');
    const list = Array.isArray(window.entries)? window.entries : [];
    await Promise.all(list.map(e => setDoc(doc(base, e.id), e, { merge: true })));
    setCloudStatus('Mentve (felh≈ë szinkron) ' + new Date().toLocaleTimeString('hu-HU'));
  }
  async function cloudDeleteEntry(id){
    const base = collection(db, 'entries');
    await deleteDoc(doc(base, id));
  }

  // --- Eredeti f√ºggv√©nyek becsomagol√°sa ---
  // saveAll wrap
  const __origSaveAll = window.saveAll;
  window.saveAll = function(){
    try{ __origSaveAll && __origSaveAll(); }catch(e){}
    if(window.firebaseReady){ cloudPushAll().catch(console.warn); }
  };
  // addToList wrap
  const __origAddToList = window.addToList;
  window.addToList = function(kind, value){
    try{ __origAddToList && __origAddToList(kind, value); }catch(e){}
    if(window.firebaseReady){ cloudPushLists().catch(console.warn); }
  };
  // remove wrap
  const __origRemove = window.remove;
  window.remove = function(id){
    try{ __origRemove && __origRemove(id); }catch(e){}
    if(window.firebaseReady){ cloudDeleteEntry(id).catch(console.warn); }
  };

  // --- Anonim bejelentkez√©s √©s feliratkoz√°sok ---
  // Jelentkezz√ºnk be anonim m√≥don √©s kezelj√ºk a hib√°t
signInAnonymously(auth).catch(err=>{
  console.warn('Anon sign-in failed:', err);
  setCloudStatus('Bejelentkez√©s hiba: '+ (err?.code||'ismeretlen'));
});
  onAuthStateChanged(auth, async (user) => {
    // Figyelmeztet√©s file:// originre
    if (location.protocol === 'file:') {
      setCloudStatus('Figyelem: file:// alatt az Auth nem m≈±k√∂dik. Ind√≠tsd szerverr≈ël (pl. http://localhost).');
    }

    if(!user){
      setCloudStatus('Nincs bejelentkezve (ellen≈ërizd: Anonymous Auth enged√©lyezve-e, √©s a domain fel van-e v√©ve).');
      return;
    }
    window.firebaseReady = true;
    setCloudStatus('Bejelentkezve ‚Ä¢ szinkron akt√≠v');

    // ---- ELS≈ê INDUL√ÅSI SZINKRON ----
    try {
      // Ha a felh≈ë √ºres, de lok√°lban van adat, toljuk fel el≈ësz√∂r
      const entriesCol = collection(db, 'entries');
      const entriesSnap = await getDocs(entriesCol);
      if (entriesSnap.empty && Array.isArray(window.entries) && window.entries.length > 0) {
        setCloudStatus('Felh≈ë √ºres ‚Üí els≈ë felt√∂lt√©s‚Ä¶');
        await cloudPushAll();
      }
      const listsRefInit = doc(db, 'lists', 'laundry');
      const listsDocInit = await getDoc(listsRefInit);
      if (!listsDocInit.exists() && ( (window.detergents&&window.detergents.length) || (window.softeners&&window.softeners.length) || (window.programs&&window.programs.length) )) {
        await cloudPushLists();
      }
    } catch (e) {
      console.warn('Initial sync check failed:', e);
    }

    // List√°k feliratkoz√°s
    const listsRef = doc(db, 'lists', 'laundry');
    onSnapshot(listsRef, (snap)=>{
      const data = snap.data() || {};
      window._cloudApplying = true;
      try{
        if(Array.isArray(data.detergents)) window.detergents = data.detergents;
        if(Array.isArray(data.softeners))  window.softeners  = data.softeners;
        if(Array.isArray(data.programs))   window.programs   = data.programs;
        if(typeof rebuildSelects === 'function') rebuildSelects();
        if(typeof rebuildFilterOptions === 'function') rebuildFilterOptions();
        if(typeof __origSaveAll === 'function') __origSaveAll();
      } finally { window._cloudApplying = false; }
    });

    // Bejegyz√©sek feliratkoz√°s
    const entriesRef = collection(db, 'entries');
    const qy = query(entriesRef, orderBy('date','desc'));
    onSnapshot(qy, (snap)=>{
      const cloud = [];
      snap.forEach(docSnap => cloud.push(docSnap.data()));
      window._cloudApplying = true;
      try{
        window.entries = cloud;
        if(typeof render === 'function') render();
        if(typeof __origSaveAll === 'function') __origSaveAll();
      } finally { window._cloudApplying = false; }
    });
  });

    // Bejegyz√©sek feliratkoz√°s
    const entriesRef = collection(db, 'entries');
    const qy = query(entriesRef, orderBy('date','desc'));
    onSnapshot(qy, (snap)=>{
      const cloud = [];
      snap.forEach(docSnap => cloud.push(docSnap.data()));
      window._cloudApplying = true;
      try{
        window.entries = cloud;
        if(typeof render === 'function') render();
        if(typeof saveAll === 'function') __origSaveAll && __origSaveAll();
      } finally { window._cloudApplying = false; }
    });
  });

    // Bejegyz√©sek feliratkoz√°s
    const entriesRef = collection(db, 'entries');
    const qy = query(entriesRef, orderBy('date','desc'));
    onSnapshot(qy, (snap)=>{
      const cloud = [];
      snap.forEach(docSnap => cloud.push(docSnap.data()));
      window._cloudApplying = true;
      try{
        window.entries = cloud;
        if(typeof render === 'function') render();
        if(typeof saveAll === 'function') __origSaveAll && __origSaveAll();
      } finally { window._cloudApplying = false; }
    });
  });
</script>
</body>
</html>
